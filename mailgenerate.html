<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>批量信件生成器 (Outlook專用版)</title>
    <!-- 引入 Tailwind CSS 進行樣式設定 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Lucide Icons 圖示庫 -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* 共用的列表樣式：針對編輯器、預覽區塊以及複製用的隱藏區塊 */
        #editor-content,
        .email-content,
        .outlook-copy-wrapper {
            font-family: 'Calibri', sans-serif;
            font-size: 12pt;
            line-height: 1.5;
            color: #000000;
        }

        /* 超連結樣式：強制藍色底線 */
        #editor-content a,
        .email-content a,
        .outlook-copy-wrapper a {
            color: blue !important;
            text-decoration: underline !important;
            cursor: pointer;
        }

        /* 強制復原列表樣式 */
        #editor-content ul,
        .email-content ul,
        .outlook-copy-wrapper ul {
            list-style-type: disc !important;
            margin-left: 24px !important;
            margin-bottom: 8px;
        }

        #editor-content ol,
        .email-content ol,
        .outlook-copy-wrapper ol {
            list-style-type: decimal !important;
            margin-left: 24px !important;
            margin-bottom: 8px;
        }

        #editor-content li,
        .email-content li,
        .outlook-copy-wrapper li {
            padding-left: 4px;
        }

        /* 編輯器高度設定 */
        #editor-content {
            min-height: 300px;
        }

        /* 隱藏未激活的標籤頁 */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* 色盤選單樣式 */
        .color-menu {
            display: none;
        }

        .color-menu.open {
            display: block;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800 font-sans min-h-screen p-4">

    <div class="max-w-5xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200">

        <!-- Header -->
        <div class="bg-blue-600 p-6 text-white flex flex-col sm:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-2xl font-bold flex items-center gap-2">
                    <i data-lucide="mail" class="h-6 w-6"></i> 批量信件生成器
                </h1>
                <p class="text-blue-100 text-sm mt-1">
                    HTML 獨立版：專為 Outlook 優化，下載即用
                </p>
            </div>
            <div class="flex gap-2 w-full sm:w-auto overflow-x-auto">
                <button onclick="switchTab('data')" id="btn-tab-data"
                    class="tab-btn px-4 py-2 rounded-lg text-sm font-medium transition-colors bg-white text-blue-600">
                    1. 匯入資料
                </button>
                <button onclick="switchTab('template')" id="btn-tab-template"
                    class="tab-btn px-4 py-2 rounded-lg text-sm font-medium transition-colors bg-blue-700 text-white hover:bg-blue-500">
                    2. 編輯模板
                </button>
                <button onclick="switchTab('preview')" id="btn-tab-preview"
                    class="tab-btn px-4 py-2 rounded-lg text-sm font-medium transition-colors bg-blue-700 text-white hover:bg-blue-500">
                    3. 預覽發送
                </button>
            </div>
        </div>

        <!-- Content Area -->
        <div class="p-6">

            <!-- STEP 1: DATA INPUT -->
            <div id="tab-data" class="tab-content active space-y-4">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-semibold flex items-center gap-2">
                        <i data-lucide="users" class="h-5 w-5 text-blue-600"></i> 資料來源
                    </h2>
                    <span id="data-count" class="text-sm text-gray-500 bg-gray-100 px-3 py-1 rounded-full">
                        共 0 筆
                    </span>
                </div>

                <div class="bg-blue-50 p-4 rounded-lg border border-blue-100 text-sm text-blue-800 mb-4">
                    <p class="font-bold flex items-center gap-2"><i data-lucide="alert-circle" class="h-4 w-4"></i>
                        使用說明：</p>
                    <ul class="list-disc list-inside mt-1 ml-1 space-y-1">
                        <li>請直接從 Excel 複製表格內容（含標題列）並貼在下方。</li>
                        <li>第一列必須是「標題」（例如：姓名、Email），這些將成為變數。</li>
                    </ul>
                </div>

                <textarea id="csv-input"
                    class="w-full h-64 p-4 border border-gray-300 rounded-lg font-mono text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                    placeholder="在此貼上 Excel 資料..."></textarea>

                <div id="table-preview-container" class="overflow-x-auto border rounded-lg mt-4 hidden">
                    <!-- 表格預覽將生成於此 -->
                </div>
            </div>

            <!-- STEP 2: TEMPLATE EDITOR -->
            <div id="tab-template" class="tab-content space-y-6">
                <div class="flex justify-between items-start">
                    <h2 class="text-xl font-semibold flex items-center gap-2">
                        <i data-lucide="file-text" class="h-5 w-5 text-blue-600"></i> 信件模板
                    </h2>
                    <div class="w-1/3 text-right">
                        <span class="text-xs text-gray-500 block mb-1">插入變數</span>
                        <div id="variable-buttons" class="flex flex-wrap gap-1 justify-end">
                            <!-- 變數按鈕將生成於此 -->
                        </div>
                    </div>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">主旨</label>
                        <input type="text" id="subject-input"
                            class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">副本 (CC)</label>
                        <input type="text" id="cc-input"
                            class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">內文 (預設字體: Calibri, 12pt)</label>

                        <!-- Toolbar -->
                        <div
                            class="flex flex-wrap gap-1 p-2 bg-gray-100 border border-b-0 border-gray-300 rounded-t-md select-none items-center relative">
                            <button onmousedown="handleToolbar(event, 'bold')" class="p-1.5 hover:bg-gray-200 rounded"
                                title="粗體"><i data-lucide="bold" class="w-4 h-4"></i></button>
                            <button onmousedown="handleToolbar(event, 'italic')" class="p-1.5 hover:bg-gray-200 rounded"
                                title="斜體"><i data-lucide="italic" class="w-4 h-4"></i></button>
                            <button onmousedown="handleToolbar(event, 'underline')"
                                class="p-1.5 hover:bg-gray-200 rounded" title="底線"><i data-lucide="underline"
                                    class="w-4 h-4"></i></button>

                            <div class="w-px h-6 bg-gray-300 mx-1 self-center"></div>

                            <!-- 文字顏色 (Dropdown) -->
                            <div class="relative inline-block">
                                <button onmousedown="toggleColorMenu(event, 'text-color-menu')"
                                    class="p-1.5 hover:bg-gray-200 rounded flex items-center gap-1" title="文字顏色">
                                    <i data-lucide="type" class="w-4 h-4"></i>
                                    <div class="w-3 h-3 rounded-full bg-black border border-gray-300"></div>
                                </button>
                                <!-- 色盤選單 -->
                                <div id="text-color-menu"
                                    class="color-menu absolute top-full left-0 mt-1 p-3 bg-white border border-gray-200 shadow-xl rounded-lg z-50 w-40">
                                    <div class="text-xs text-gray-500 mb-2 font-bold">常用顏色</div>
                                    <div class="grid grid-cols-4 gap-2">
                                        <button onmousedown="applyColor(event, 'foreColor', '#000000')"
                                            class="w-6 h-6 rounded-full bg-black border border-gray-200 hover:scale-110 transition-transform shadow-sm"
                                            title="黑色"></button>
                                        <button onmousedown="applyColor(event, 'foreColor', '#FF0000')"
                                            class="w-6 h-6 rounded-full bg-red-600 border border-gray-200 hover:scale-110 transition-transform shadow-sm"
                                            title="紅色"></button>
                                        <button onmousedown="applyColor(event, 'foreColor', '#0000FF')"
                                            class="w-6 h-6 rounded-full bg-blue-600 border border-gray-200 hover:scale-110 transition-transform shadow-sm"
                                            title="藍色"></button>
                                        <button onmousedown="applyColor(event, 'foreColor', '#008000')"
                                            class="w-6 h-6 rounded-full bg-green-600 border border-gray-200 hover:scale-110 transition-transform shadow-sm"
                                            title="綠色"></button>
                                        <button onmousedown="applyColor(event, 'foreColor', '#FFA500')"
                                            class="w-6 h-6 rounded-full bg-orange-500 border border-gray-200 hover:scale-110 transition-transform shadow-sm"
                                            title="橘色"></button>
                                        <button onmousedown="applyColor(event, 'foreColor', '#800080')"
                                            class="w-6 h-6 rounded-full bg-purple-600 border border-gray-200 hover:scale-110 transition-transform shadow-sm"
                                            title="紫色"></button>
                                        <button onmousedown="applyColor(event, 'foreColor', '#808080')"
                                            class="w-6 h-6 rounded-full bg-gray-500 border border-gray-200 hover:scale-110 transition-transform shadow-sm"
                                            title="灰色"></button>
                                        <button onmousedown="applyColor(event, 'foreColor', '#FFFFFF')"
                                            class="w-6 h-6 rounded-full bg-white border border-gray-300 hover:scale-110 transition-transform shadow-sm"
                                            title="白色"></button>
                                    </div>
                                </div>
                            </div>

                            <!-- 背景顏色 (Dropdown) -->
                            <div class="relative inline-block">
                                <button onmousedown="toggleColorMenu(event, 'bg-color-menu')"
                                    class="p-1.5 hover:bg-gray-200 rounded flex items-center gap-1" title="背景顏色 (螢光筆)">
                                    <i data-lucide="highlighter" class="w-4 h-4"></i>
                                    <div class="w-3 h-3 rounded-full bg-yellow-300 border border-gray-300"></div>
                                </button>
                                <!-- 色盤選單 -->
                                <div id="bg-color-menu"
                                    class="color-menu absolute top-full left-0 mt-1 p-3 bg-white border border-gray-200 shadow-xl rounded-lg z-50 w-40">
                                    <div class="text-xs text-gray-500 mb-2 font-bold">螢光筆</div>
                                    <div class="grid grid-cols-4 gap-2">
                                        <button onmousedown="applyColor(event, 'hiliteColor', '#FFFF00')"
                                            class="w-6 h-6 rounded-full bg-yellow-300 border border-gray-200 hover:scale-110 transition-transform shadow-sm"
                                            title="黃色"></button>
                                        <button onmousedown="applyColor(event, 'hiliteColor', '#00FF00')"
                                            class="w-6 h-6 rounded-full bg-green-300 border border-gray-200 hover:scale-110 transition-transform shadow-sm"
                                            title="綠色"></button>
                                        <button onmousedown="applyColor(event, 'hiliteColor', '#00FFFF')"
                                            class="w-6 h-6 rounded-full bg-cyan-300 border border-gray-200 hover:scale-110 transition-transform shadow-sm"
                                            title="藍色"></button>
                                        <button onmousedown="applyColor(event, 'hiliteColor', '#FF00FF')"
                                            class="w-6 h-6 rounded-full bg-pink-300 border border-gray-200 hover:scale-110 transition-transform shadow-sm"
                                            title="粉色"></button>
                                        <button onmousedown="applyColor(event, 'hiliteColor', '#D1D5DB')"
                                            class="w-6 h-6 rounded-full bg-gray-300 border border-gray-200 hover:scale-110 transition-transform shadow-sm"
                                            title="灰色"></button>
                                        <button onmousedown="applyColor(event, 'hiliteColor', 'transparent')"
                                            class="w-6 h-6 rounded-full bg-white border border-gray-300 hover:scale-110 transition-transform shadow-sm relative text-red-500 flex items-center justify-center font-bold"
                                            title="清除">
                                            <i data-lucide="x" class="w-3 h-3"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="w-px h-6 bg-gray-300 mx-1 self-center"></div>

                            <button onmousedown="handleToolbar(event, 'insertUnorderedList')"
                                class="p-1.5 hover:bg-gray-200 rounded" title="項目符號"><i data-lucide="list"
                                    class="w-4 h-4"></i></button>

                            <div class="w-px h-6 bg-gray-300 mx-1 self-center"></div>

                            <button onmousedown="handleToolbar(event, 'createLink')"
                                class="p-1.5 hover:bg-gray-200 rounded" title="插入超連結"><i data-lucide="link"
                                    class="w-4 h-4"></i></button>
                            <button onmousedown="handleToolbar(event, 'unlink')" class="p-1.5 hover:bg-gray-200 rounded"
                                title="移除超連結"><i data-lucide="link-2-off" class="w-4 h-4"></i></button>
                        </div>

                        <!-- Content Editable Div -->
                        <div id="editor-content" contenteditable="true"
                            class="w-full p-4 border border-gray-300 rounded-b-md focus:ring-2 focus:ring-blue-500 outline-none overflow-y-auto">
                        </div>
                    </div>
                </div>
            </div>

            <!-- STEP 3: PREVIEW & GENERATE -->
            <div id="tab-preview" class="tab-content space-y-6">
                <h2 class="text-xl font-semibold flex items-center gap-2">
                    <i data-lucide="play" class="h-5 w-5 text-blue-600"></i> 預覽與發送
                </h2>

                <div
                    class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-sm text-yellow-800 flex items-start gap-2">
                    <i data-lucide="alert-circle" class="h-5 w-5 flex-shrink-0 mt-0.5"></i>
                    <div>
                        <strong>Outlook 貼上技巧：</strong>
                        <p>系統已將內容轉換為 Outlook 友善的格式。若貼上後仍有問題，請在 Outlook 貼上時選擇「保留來源格式」。</p>
                    </div>
                </div>

                <div id="preview-container" class="grid gap-6">
                    <!-- 預覽卡片將生成於此 -->
                    <div class="text-center py-10 bg-gray-50 border border-dashed rounded-lg text-gray-500">
                        請先輸入資料並確認模板
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- JavaScript Logic -->
    <script>
        // --- 初始狀態與變數 ---
        const defaultData = `姓名,Email,學校,課程名稱,課程連結
王大明,ming@example.com,臺北科技大學,人工智慧導論,https://ntut.edu.tw/ai
李小華,hua@example.com,成功大學,Python基礎,https://ncku.edu.tw/python
張志明,chang@example.com,清華大學,資料結構,https://nthu.edu.tw/ds`;

        const defaultBody = `<div><span style="font-family: Calibri, sans-serif; font-size: 12pt;">您好 <b>{姓名}</b> 老師：</span></div><br><div><span style="font-family: Calibri, sans-serif; font-size: 12pt;">感謝您在 {學校} 開設「<span style="color: blue;">{課程名稱}</span>」。</span></div><div><span style="font-family: Calibri, sans-serif; font-size: 12pt;">您的課程連結如下：</span></div><div><a href="{課程連結}" style="font-family: Calibri, sans-serif; font-size: 12pt;">{課程連結}</a></div><br><div><span style="font-family: Calibri, sans-serif; font-size: 12pt;">請確認內容是否無誤。</span></div><br><div><span style="font-family: Calibri, sans-serif; font-size: 12pt;">教務團隊 敬上</span></div>`;

        let state = {
            csvInput: defaultData,
            subjectTemplate: '關於 {學校} 的 {課程名稱} 開課通知',
            ccTemplate: '',
            parsedData: [],
            headers: []
        };

        let savedRange = null; // 用於儲存選取範圍

        // DOM 元素引用
        const els = {
            csvInput: document.getElementById('csv-input'),
            dataCount: document.getElementById('data-count'),
            tablePreview: document.getElementById('table-preview-container'),
            variableButtons: document.getElementById('variable-buttons'),
            subjectInput: document.getElementById('subject-input'),
            ccInput: document.getElementById('cc-input'),
            editor: document.getElementById('editor-content'),
            previewContainer: document.getElementById('preview-container'),
            btns: {
                data: document.getElementById('btn-tab-data'),
                template: document.getElementById('btn-tab-template'),
                preview: document.getElementById('btn-tab-preview')
            },
            tabs: {
                data: document.getElementById('tab-data'),
                template: document.getElementById('tab-template'),
                preview: document.getElementById('tab-preview')
            }
        };

        // --- 初始化 ---
        function init() {
            els.csvInput.value = state.csvInput;
            els.subjectInput.value = state.subjectTemplate;
            els.editor.innerHTML = defaultBody;

            // 綁定事件
            els.csvInput.addEventListener('input', (e) => {
                state.csvInput = e.target.value;
                parseData();
            });

            els.subjectInput.addEventListener('input', (e) => state.subjectTemplate = e.target.value);
            els.ccInput.addEventListener('input', (e) => state.ccTemplate = e.target.value);

            // 點擊外部關閉色盤
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.relative.inline-block')) {
                    closeAllMenus();
                }
            });

            parseData(); // 初次解析
            lucide.createIcons();
        }

        // --- 核心邏輯 ---

        // 1. 切換分頁
        function switchTab(tabName) {
            Object.keys(els.btns).forEach(key => {
                const btn = els.btns[key];
                if (key === tabName) {
                    btn.className = "tab-btn px-4 py-2 rounded-lg text-sm font-medium transition-colors bg-white text-blue-600";
                } else {
                    btn.className = "tab-btn px-4 py-2 rounded-lg text-sm font-medium transition-colors bg-blue-700 text-white hover:bg-blue-500";
                }
            });

            Object.keys(els.tabs).forEach(key => {
                const tab = els.tabs[key];
                if (key === tabName) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });

            if (tabName === 'preview') {
                renderPreview();
            }
        }

        // 2. 解析 CSV
        function parseData() {
            const input = state.csvInput.trim();
            if (!input) {
                state.parsedData = [];
                state.headers = [];
                updateDataUI();
                return;
            }

            const rows = input.split('\n');
            if (rows.length === 0) return;

            const separator = rows[0].includes('\t') ? '\t' : ',';
            const headerRow = rows[0].split(separator).map(h => h.trim());

            state.headers = headerRow;
            state.parsedData = rows.slice(1).map(row => {
                const values = row.split(separator).map(v => v.trim());
                const obj = {};
                headerRow.forEach((header, index) => {
                    obj[header] = values[index] || '';
                });
                return obj;
            });

            updateDataUI();
        }

        // 3. 更新資料介面
        function updateDataUI() {
            els.dataCount.innerText = `共 ${state.parsedData.length} 筆`;
            if (state.parsedData.length > 0) {
                let tableHTML = `<table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>`;
                state.headers.forEach(h => {
                    tableHTML += `<th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase whitespace-nowrap">${h}</th>`;
                });
                tableHTML += `</tr></thead><tbody class="bg-white divide-y divide-gray-200">`;
                state.parsedData.slice(0, 3).forEach(row => {
                    tableHTML += `<tr>`;
                    state.headers.forEach(h => {
                        tableHTML += `<td class="px-3 py-2 text-sm text-gray-700 whitespace-nowrap">${row[h]}</td>`;
                    });
                    tableHTML += `</tr>`;
                });
                tableHTML += `</tbody></table>`;
                els.tablePreview.innerHTML = tableHTML;
                els.tablePreview.classList.remove('hidden');
            } else {
                els.tablePreview.classList.add('hidden');
            }
            els.variableButtons.innerHTML = '';
            state.headers.forEach(h => {
                const btn = document.createElement('button');
                btn.className = "px-2 py-1 bg-gray-100 hover:bg-gray-200 border border-gray-300 rounded text-xs text-gray-700 transition-colors";
                btn.innerText = `{${h}}`;
                btn.onmousedown = (e) => insertVariable(e, `{${h}}`);
                els.variableButtons.appendChild(btn);
            });
        }

        // 4. 編輯器工具列功能
        function handleToolbar(e, command) {
            e.preventDefault();
            els.editor.focus();
            if (command === 'createLink') {
                const url = prompt("請輸入網址：", "https://");
                if (url) {
                    document.execCommand(command, false, url);
                }
            } else if (command === 'unlink') {
                document.execCommand('unlink', false, null);
            } else {
                document.execCommand(command, false, null);
            }
        }

        // 4.1 顏色選單邏輯
        function saveSelection() {
            const sel = window.getSelection();
            if (sel.rangeCount > 0) {
                savedRange = sel.getRangeAt(0);
            }
        }

        function restoreSelection() {
            if (savedRange) {
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(savedRange);
            }
        }

        function closeAllMenus() {
            document.querySelectorAll('.color-menu').forEach(menu => {
                menu.classList.remove('open');
            });
        }

        function toggleColorMenu(e, menuId) {
            e.preventDefault();
            e.stopPropagation();

            // 先儲存編輯器的選取狀態
            saveSelection();

            const menu = document.getElementById(menuId);
            const isOpen = menu.classList.contains('open');

            closeAllMenus(); // 關閉其他

            if (!isOpen) {
                menu.classList.add('open');
            }
        }

        function applyColor(e, command, value) {
            e.preventDefault();
            e.stopPropagation();

            // 還原選取狀態
            restoreSelection();
            els.editor.focus();

            document.execCommand(command, false, value);
            closeAllMenus();
        }

        // 5. 插入變數
        function insertVariable(e, variable) {
            e.preventDefault();
            els.editor.focus();
            document.execCommand('insertText', false, variable);
        }

        // 6. 渲染預覽
        function renderPreview() {
            const bodyTemplate = els.editor.innerHTML;
            if (state.parsedData.length === 0) {
                els.previewContainer.innerHTML = '<div class="text-center py-10 bg-gray-50 border border-dashed rounded-lg text-gray-500">沒有資料，請先至「匯入資料」頁籤貼上資料。</div>';
                return;
            }
            els.previewContainer.innerHTML = '';
            state.parsedData.forEach((row, index) => {
                const finalSubject = replaceVariables(state.subjectTemplate, row);
                const finalCC = replaceVariables(state.ccTemplate, row);
                const finalBodyHtml = replaceVariables(bodyTemplate, row);
                const plainTextBody = stripHtml(finalBodyHtml);
                const mailtoLink = `mailto:${row['Email'] || row['email'] || ''}?cc=${finalCC}&subject=${encodeURIComponent(finalSubject)}&body=${encodeURIComponent(plainTextBody)}`;

                const card = document.createElement('div');
                card.className = "bg-white border border-gray-200 rounded-lg shadow-sm";
                card.innerHTML = `
                    <div class="bg-gray-50 px-4 py-3 border-b border-gray-200 flex flex-col sm:flex-row justify-between sm:items-center gap-2">
                        <div class="text-sm text-gray-600">
                            <span class="font-bold text-gray-800">#${index + 1}</span> 
                            <span class="mx-2">|</span>
                            收件人: <span class="font-mono text-blue-700">${row['Email'] || row['email'] || '未填寫'}</span>
                            ${finalCC ? `<span class="ml-3 text-gray-500">副本: ${finalCC}</span>` : ''}
                        </div>
                        <div class="flex gap-2">
                            <button onclick="copyToClipboard(this, ${index})" data-content="${encodeURIComponent(finalBodyHtml)}" class="flex items-center gap-1 px-3 py-1.5 bg-green-600 text-white rounded text-sm hover:bg-green-700 transition-colors shadow-sm">
                                <i data-lucide="copy" class="h-4 w-4"></i> 複製格式內容
                            </button>
                            <a href="${mailtoLink}" class="flex items-center gap-1 px-3 py-1.5 bg-white border border-gray-300 text-gray-600 rounded text-sm hover:bg-gray-50 no-underline decoration-0">
                                <i data-lucide="mail" class="h-4 w-4"></i> 僅文字開啟
                            </a>
                        </div>
                    </div>
                    <div class="p-4 space-y-3">
                        <div class="flex gap-2 items-baseline border-b border-gray-100 pb-2">
                            <span class="text-xs font-bold text-gray-400 uppercase w-10 flex-shrink-0">主旨</span>
                            <p class="font-medium text-gray-900">${finalSubject}</p>
                        </div>
                        <div class="flex gap-2 items-start">
                            <span class="text-xs font-bold text-gray-400 uppercase w-10 flex-shrink-0 mt-1">內文</span>
                            <div class="flex-1 p-3 bg-white border border-gray-200 rounded text-sm text-gray-800 leading-relaxed max-w-none email-content"
                                 style="font-family: Calibri, sans-serif; font-size: 12pt;">
                                ${finalBodyHtml}
                            </div>
                        </div>
                    </div>
                `;
                els.previewContainer.appendChild(card);
            });
            lucide.createIcons();
        }

        function replaceVariables(template, rowData) {
            let result = template;
            state.headers.forEach(header => {
                const regex = new RegExp(`{${header}}`, 'g');
                result = result.replace(regex, rowData[header] || '');
            });
            return result;
        }

        function stripHtml(html) {
            const temp = document.createElement('div');
            temp.innerHTML = html;
            return temp.innerText || temp.textContent || '';
        }

        // RGB 轉 Hex 的字串替換函式
        function convertRgbToHexInHtml(html) {
            return html.replace(/rgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/gi, (match, r, g, b) => {
                const toHex = (n) => {
                    const hex = parseInt(n).toString(16);
                    return hex.length === 1 ? '0' + hex : hex;
                };
                return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
            });
        }

        // 9. 複製到剪貼簿 (Outlook 專用邏輯 - 使用 clipboardData 攔截)
        function copyToClipboard(btn, index) {
            const rawHtml = decodeURIComponent(btn.getAttribute('data-content'));

            // 創建 DOM 處理元素
            const processor = document.createElement('div');
            processor.innerHTML = rawHtml;

            const fontFamily = "'Calibri', sans-serif";
            const fontSize = "12pt";
            const color = "#000000";

            // 遍歷元素做基本正規化 (但不過度強制黑色)
            const allElements = processor.querySelectorAll('*');
            allElements.forEach(el => {
                el.removeAttribute('class');

                if (!el.style.fontFamily) el.style.fontFamily = fontFamily;
                if (!el.style.fontSize) el.style.fontSize = fontSize;

                // 只有在最外層或沒有顏色時才設定黑色，避免覆蓋子元素顏色
                if (!el.style.color && el.tagName !== 'A' && !['B', 'STRONG', 'I', 'EM', 'SPAN'].includes(el.tagName)) {
                    // el.style.color = color; // 暫時移除強制黑色，依靠最外層繼承
                }

                if (['B', 'STRONG'].includes(el.tagName) || el.style.fontWeight === 'bold' || parseInt(el.style.fontWeight) >= 700) {
                    el.style.fontWeight = 'bold';
                }

                if (['I', 'EM'].includes(el.tagName) || el.style.fontStyle === 'italic') {
                    el.style.fontStyle = 'italic';
                }

                if (['U'].includes(el.tagName) || el.style.textDecoration.includes('underline')) {
                    el.style.textDecoration = 'underline';
                }

                if (['UL', 'OL'].includes(el.tagName)) {
                    el.style.marginLeft = '24px';
                    el.style.paddingLeft = '0';
                }

                if (el.tagName === 'LI') {
                    el.style.fontFamily = fontFamily;
                    el.style.fontSize = fontSize;
                    el.style.marginBottom = '4px';
                }

                if (el.tagName === 'A') {
                    el.style.color = 'blue';
                    el.style.textDecoration = 'underline';
                }
            });

            // 處理 RGB 轉 Hex
            let processedHtml = processor.innerHTML;
            processedHtml = convertRgbToHexInHtml(processedHtml);

            // 建立最終 HTML 字串
            const finalHtml = `
                <div style="font-family: ${fontFamily}; font-size: ${fontSize}; color: ${color};">
                    ${processedHtml}
                </div>
            `;
            const plainText = processor.innerText || processor.textContent;

            // --- 核心修改：攔截 copy 事件 ---
            // 這是唯一能確保傳送純淨 Hex HTML 給 Outlook 的方法，繞過瀏覽器重組 DOM 的行為
            const listener = (e) => {
                e.preventDefault();
                e.clipboardData.setData('text/html', finalHtml);
                e.clipboardData.setData('text/plain', plainText);
            };

            document.addEventListener('copy', listener);

            try {
                const successful = document.execCommand('copy');
                document.removeEventListener('copy', listener); // 立即移除監聽器

                if (successful) {
                    const originalHtml = btn.innerHTML;
                    btn.innerHTML = `<i data-lucide="check" class="h-4 w-4"></i> 已複製`;
                    lucide.createIcons();
                    setTimeout(() => {
                        btn.innerHTML = originalHtml;
                        lucide.createIcons();
                    }, 2000);
                } else {
                    alert("複製失敗");
                }
            } catch (err) {
                document.removeEventListener('copy', listener);
                console.error('Copy failed', err);
                alert("瀏覽器不支援，請手動複製");
            }
        }

        // 啟動
        init();
    </script>
</body>

</html>